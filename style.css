// ======================================================
// CONFIGURACI√ìN GEMINI + LOG√çSTICA ROSSETTON - BOT IA
// ======================================================

// API GEMINI
const GEMINI_API_KEY = "AIzaSyD-Wy2D969Vy2f6RY5aNb2NgNZrU1sMn44";
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

const PROMPT_SISTEMA = `
Sos el asistente virtual de Log√≠stica Rossetton, un servicio de env√≠os y retiros en Argentina.
Tu personalidad:
- Habl√°s como un pibe de Argentina, buena onda, respetuoso, claro y profesional.
- Sos s√∫per inteligente, pero si algo no te queda claro, NO digas "no entiendo":
  - En vez de eso, hac√© preguntas espec√≠ficas y √∫tiles para aclarar.
- Siempre manten√© el foco en entender si la persona quiere:
  1) Enviar algo
  2) Retirar algo
  3) Hacer una consulta

Objetivo principal:
- Detectar si el cliente quiere ENV√çO, RETIRO o solo CONSULTA.
- Si es ENV√çO o RETIRO, tu misi√≥n es conseguir la mayor cantidad de datos posible:
  - Direcci√≥n y localidad de ORIGEN
  - Direcci√≥n y localidad de DESTINO
  - Tel√©fono de quien entrega y/o recibe
  - Tipo de lugar: casa, departamento, oficina, cl√≠nica, etc.
  - Si es RETIRO: siempre preguntar DESDE D√ìNDE (direcci√≥n y localidad) y A NOMBRE DE QUI√âN se retira.
  - Preguntar si es solo ida o ida y vuelta.

Estilo de respuesta:
- Siempre respond√© en un solo mensaje, corto y claro.
- Pod√©s usar emojis con criterio (por ejemplo üõµ, üì¶, ‚úÖ, üòâ).
- Nunca digas que sos una IA, solo sos el asistente de Log√≠stica Rossetton.
`;

// ======================================================
// CONFIGURACI√ìN GOOGLE SHEETS + SONIDOS
// ======================================================

const URL_GOOGLE_SHEETS = "https://script.google.com/macros/s/AKfycbys09jDL6F1pQpySwUO9m5nykao1q3tzTjg3ajJu5X79inxi79VHdNXns0KTWo2U7ot/exec";

const sonidoUsuario = new Audio("https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3");
const sonidoBot = new Audio("https://assets.mixkit.co/active_storage/sfx/1117/1117-preview.mp3");
sonidoUsuario.volume = 0.3;
sonidoBot.volume = 0.3;

// ======================================================
// ESTADO DEL BOT
// ======================================================

var botEstado = {
    paso: "saludo",
    tipo: null, // "envio" | "retiro" | null
    nombreCliente: "",
    datos: {
        origen: "",
        destino: "",
        detalles: "",
        nombre: "",
        telOrigen: "",
        telDestino: "",
        tipoOrigen: "",
        tipoDestino: ""
    },
    esIdaVuelta: false
};

// ======================================================
// MOTOR DE INTELIGENCIA LOCAL (EXTRACCI√ìN DE DATOS)
// ======================================================

function esDireccionIncompleta(dir) {
    if (!dir) return true;
    const palabras = dir.split(" ");
    const tieneNumero = /\d/.test(dir);
    return (palabras.length < 3 && !tieneNumero);
}

function analizarMensaje(texto) {
    const envioKeywords = /envio|enviar|mandar|llevar|alcanzar|dejar|lleven|manden|lleve/i;
    const retiroKeywords = /retiro|retirar|traer|busquen|busc|traigan|buscame|traeme/i;

    if (envioKeywords.test(texto) && retiroKeywords.test(texto)) {
        botEstado.esIdaVuelta = true;
        botEstado.tipo = "envio";
    } else if (retiroKeywords.test(texto)) {
        botEstado.tipo = "retiro";
    } else if (envioKeywords.test(texto)) {
        botEstado.tipo = "envio";
    }

    const limpiarDireccion = (t) => {
        return t.replace(/mi casa es|mi dire es|mi direcci√≥n es|mi direccion es|mi dire|mi direccion|mi casa/gi, "").trim();
    };

    const regHasta = /(?:hasta|hacia|a la|al|destino|para|llevalo a|entregalo en) ([\w\s√Å√â√ç√ì√ö√°√©√≠√≥√∫√±0-9]+)/i;
    const regDesde = /(?:desde|de|origen|salida|en|buscalo en|retiralo en) ([\w\s√Å√â√ç√ì√ö√°√©√≠√≥√∫√±0-9]+)/i;

    const matchHasta = texto.match(regHasta);
    const matchDesde = texto.match(regDesde);

    if (matchHasta) {
        let limpio = limpiarDireccion(matchHasta[1]);
        if (!esDireccionIncompleta(limpio)) botEstado.datos.destino = limpio;
    }
    if (matchDesde) {
        let limpio = limpiarDireccion(matchDesde[1]);
        if (!esDireccionIncompleta(limpio)) botEstado.datos.origen = limpio;
    }

    const telRegex = /(\+?\d[\d\s\-]{6,})/g;
    const telefonos = texto.match(telRegex);
    if (telefonos && telefonos.length > 0) {
        if (!botEstado.datos.telOrigen) botEstado.datos.telOrigen = telefonos[0].trim();
        if (telefonos[1] && !botEstado.datos.telDestino) botEstado.datos.telDestino = telefonos[1].trim();
    }

    const tipoLugarRegex = /(casa|departamento|dpto|oficina|clinica|cl√≠nica|local)/i;
    const tipoMatch = texto.match(tipoLugarRegex);
    if (tipoMatch) {
        if (!botEstado.datos.tipoOrigen) botEstado.datos.tipoOrigen = tipoMatch[1];
        else if (!botEstado.datos.tipoDestino) botEstado.datos.tipoDestino = tipoMatch[1];
    }
}

// ======================================================
// LLAMADO A GEMINI
// ======================================================

async function hablarConIA(textoParaIA) {
    try {
        const response = await fetch(GEMINI_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: PROMPT_SISTEMA + "\n\n" + textoParaIA }]
                }]
            })
        });

        const data = await response.json();

        if (data.error) {
            console.error("ERROR GEMINI:", data.error);
            return "Che, hubo un problema t√©cnico con el servidor. Probemos de nuevo en un ratito, ¬øte parece?";
        }

        if (data.candidates && data.candidates[0].content) {
            return data.candidates[0].content.parts[0].text;
        }

        return "No me qued√≥ del todo claro, ¬øme cont√°s un poquito mejor qu√© necesit√°s? üõµ";
    } catch (e) {
        console.error("ERROR CONEXI√ìN GEMINI:", e);
        return "Parece que hay un problema de conexi√≥n. Revisemos internet y probemos de nuevo en un toque.";
    }
}

// ======================================================
// L√ìGICA DE CONVERSACI√ìN + IA
// ======================================================

async function responderBotIA(mensaje) {
    const texto = mensaje.toLowerCase().trim();

    analizarMensaje(texto);
    const tieneDatosAhora = (botEstado.datos.origen !== "" || botEstado.datos.destino !== "");

    const esSoloDespedida = /^(gracias|listo|eso es todo|nada mas|nada m√°s|chau|hasta pronto|no necesito nada mas|ya esta|ya est√°)$/i.test(texto);
    if (esSoloDespedida && !tieneDatosAhora && botEstado.paso !== "saludo") {
        const instruccion = `
El cliente se est√° despidiendo y no agreg√≥ datos nuevos.
Respond√© agradeciendo con mucha buena onda, diciendo que cualquier cosa puede volver a escribir.
No pidas m√°s datos, solo despedite bien.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    const elogios = /genio|capo|crack|buenisimo|buen√≠simo|me encanta|que bueno|qu√© bueno|excelente|buen bot|amable|te pasaste/i;
    if (elogios.test(texto) && botEstado.paso !== "saludo") {
        const instruccion = `
El cliente te elogi√≥.
Agradec√© con calidez, dec√≠ que est√°s para ayudar con env√≠os y retiros, y pregunt√° si necesita algo m√°s.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (texto.includes("cancelar") || texto.includes("empezar de nuevo") || texto.includes("empezar")) {
        botEstado = {
            paso: "menu",
            tipo: null,
            nombreCliente: botEstado.nombreCliente,
            datos: {
                origen: "",
                destino: "",
                detalles: "",
                nombre: "",
                telOrigen: "",
                telDestino: "",
                tipoOrigen: "",
                tipoDestino: ""
            },
            esIdaVuelta: false
        };
        const instruccion = `
El cliente pidi√≥ reiniciar o cancelar.
Respond√© que reiniciamos todo y pregunt√° de nuevo qu√© necesita: env√≠o, retiro o consulta.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (botEstado.paso === "saludo") {
        botEstado.paso = "preguntar_nombre";
        const instruccion = `
Es el primer contacto.
Presentate como el asistente de Log√≠stica Rossetton, con buena onda, y pedile el nombre al cliente.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (botEstado.paso === "preguntar_nombre") {
        botEstado.nombreCliente = mensaje.replace(/hola|soy|me llamo|mi nombre es/gi, "").trim() || "cliente";
        botEstado.paso = "menu";
        const instruccion = `
El cliente te dijo su nombre: "${botEstado.nombreCliente}".
Saludalo por su nombre y preguntale si quiere coordinar un Env√≠o, un Retiro o hacer una consulta.
Decile que puede contarte todo el pedido directamente.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (!botEstado.tipo) {
        const instruccion = `
Todav√≠a no est√° claro si el cliente quiere ENV√çO, RETIRO o solo CONSULTA.
Seg√∫n este mensaje del cliente, trat√° de inferirlo.
Si no queda claro, preguntale de forma amable si quiere enviar algo, retirar algo o solo consultar.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (!botEstado.datos.origen || esDireccionIncompleta(botEstado.datos.origen)) {
        botEstado.paso = "origen";
        const instruccion = `
Necesit√°s pedir la direcci√≥n de ORIGEN.
Pedile al cliente calle, altura y localidad de donde sale el pedido.
Si pod√©s, tambi√©n suger√≠ que te pase el tel√©fono de contacto y si es casa, dpto, oficina o cl√≠nica.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (!botEstado.datos.destino || esDireccionIncompleta(botEstado.datos.destino)) {
        botEstado.paso = "destino";
        const instruccion = `
Necesit√°s pedir la direcci√≥n de DESTINO.
Pedile al cliente calle, altura y localidad de destino.
Si pod√©s, tambi√©n pedile tel√©fono de quien recibe y si es casa, dpto, oficina o cl√≠nica.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (botEstado.tipo === "retiro" && !botEstado.datos.nombre) {
        botEstado.paso = "nombre_quien";
        const instruccion = `
Es un RETIRO y todav√≠a no sab√©s a nombre de qui√©n se retira.
Pedile al cliente el nombre de la persona a quien hay que retirar el paquete.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (botEstado.paso !== "finalizar") {
        botEstado.paso = "finalizar";
        let tipoTxt = botEstado.esIdaVuelta ? "IDA Y VUELTA" : (botEstado.tipo ? botEstado.tipo.toUpperCase() : "ENV√çO");
        const resumen = generarResumen(botEstado.datos, botEstado.tipo);
        const instruccion = `
Ya ten√©s casi todos los datos.
Mostrale al cliente un resumen del pedido con este contenido:
${resumen}

Preguntale si quiere agregar alg√∫n detalle extra (tel√©fonos, qui√©n paga, horarios, si es ida y vuelta, etc.).
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);
        return await hablarConIA(contexto);
    }

    if (botEstado.paso === "finalizar") {
        let detallesLimpios = mensaje.replace(/nada mas|nada m√°s|eso es todo|listo|gracias/gi, "").trim();
        botEstado.datos.detalles = (detallesLimpios === "" ? "Sin detalles" : detallesLimpios) + (botEstado.esIdaVuelta ? " [CON RETORNO]" : "");

        enviarNotificacion(botEstado.datos);
        const resumen = generarResumen(botEstado.datos, botEstado.tipo);

        const instruccion = `
Ya registraste el pedido y lo enviaste a las planillas de Google Sheets.
Mostrale al cliente este resumen:
${resumen}

Agradec√© con buena onda, decile que en breve lo van a contactar y que cualquier cosa puede volver a escribir.
`;
        const contexto = construirContextoParaIA(mensaje, instruccion);

        botEstado.paso = "menu";
        botEstado.tipo = null;
        botEstado.datos = {
            origen: "",
            destino: "",
            detalles: "",
            nombre: "",
            telOrigen: "",
            telDestino: "",
            tipoOrigen: "",
            tipoDestino: ""
        };
        botEstado.esIdaVuelta = false;

        return await hablarConIA(contexto);
    }

    const instruccion = `
No qued√≥ claro el contexto exacto.
Preguntale de forma amable si necesita un Env√≠o, un Retiro o una consulta, y trat√° de guiarlo para que te d√© direcciones, localidad y tel√©fonos.
`;
    const contexto = construirContextoParaIA(mensaje, instruccion);
    return await hablarConIA(contexto);
}

function construirContextoParaIA(mensajeCliente, instruccion) {
    return `
Estado actual del pedido:
- Paso: ${botEstado.paso}
- Tipo: ${botEstado.tipo || "sin definir"}
- Nombre cliente: ${botEstado.nombreCliente || "sin nombre"}
- Origen: ${botEstado.datos.origen || "sin origen"}
- Destino: ${botEstado.datos.destino || "sin destino"}
- Tel Origen: ${botEstado.datos.telOrigen || "sin tel origen"}
- Tel Destino: ${botEstado.datos.telDestino || "sin tel destino"}
- Tipo Origen: ${botEstado.datos.tipoOrigen || "sin tipo origen"}
- Tipo Destino: ${botEstado.datos.tipoDestino || "sin tipo destino"}
- Ida y vuelta: ${botEstado.esIdaVuelta ? "s√≠" : "no"}

Mensaje del cliente:
"${mensajeCliente}"

Tu tarea ahora:
${instruccion}
`;
}

// ======================================================
// INTERFAZ Y FUNCIONES AUXILIARES
// ======================================================

async function sendMessage() {
    const input = document.getElementById("user-input");
    const text = input.value.trim();
    if (!text) return;

    sonidoUsuario.play().catch(() => {});
    addMessage(text, "user");
    input.value = "";

    const respuesta = await responderBotIA(text);
    sonidoBot.play().catch(() => {});
    addMessage(respuesta, "bot");
}

function addMessage(text, sender) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.className = "message " + sender;
    msg.innerHTML = text.replace(/\n/g, "<br>");
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function enviarNotificacion(datosFinales) {
    if (!URL_GOOGLE_SHEETS || URL_GOOGLE_SHEETS.includes("TU_URL")) return;
    const formData = new URLSearchParams();
    formData.append("nombre", botEstado.nombreCliente);
    formData.append("tipo", (botEstado.tipo || "Envio") + (botEstado.esIdaVuelta ? " + RETORNO" : ""));
    formData.append("origen", datosFinales.origen);
    formData.append("destino", datosFinales.destino);
    formData.append("detalles", datosFinales.detalles);
    fetch(URL_GOOGLE_SHEETS, { method: "POST", mode: "no-cors", body: formData.toString() });
}

function generarResumen(datos, tipo) {
    let t = botEstado.esIdaVuelta ? "IDA Y VUELTA" : (tipo ? tipo.toUpperCase() : "ENV√çO");
    return `üì¶ ${t}
üü¶ DE: ${datos.origen}
üü© A: ${datos.destino}
üìû Tel Origen: ${datos.telOrigen || "no informado"}
üìû Tel Destino: ${datos.telDestino || "no informado"}
üè† Origen: ${datos.tipoOrigen || "no informado"}
üè¢ Destino: ${datos.tipoDestino || "no informado"}
üìù INFO: ${datos.detalles || "Sin detalles"}`;
}

// Evitar error por el input file del HTML
function subirFoto(input) {
    if (input && input.files && input.files[0]) {
        addMessage("Recib√≠ la imagen, la voy a tener en cuenta para el pedido üì∑.", "bot");
    }
}

document.addEventListener("DOMContentLoaded", () => {
    setTimeout(async () => {
        const saludo = await responderBotIA("hola");
        addMessage(saludo, "bot");
    }, 800);

    const input = document.getElementById("user-input");
    if (input) {
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });
    }
});
